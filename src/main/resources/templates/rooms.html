<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Rooms in Hotel</title>
    <link rel="stylesheet" type="text/css" href="/room.css">
    <link rel="stylesheet" href="/booking-form.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .booking-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>

<!-- Логотип і кнопка профілю -->
<header>
    <div class="logo">
        <a href="/"><img src="/logo.png" alt="Logo"></a>
    </div>
    <li><a href="/profile">View Profile</a></li>
</header>

<div class="container">
    <h1 class="title">Rooms for Hotel ID: <span th:text="${hotelId}"></span></h1>

    <!-- Форма фільтрації -->
    <form method="get" th:action="@{/{hotelId}/rooms(hotelId=${hotelId})}" class="filter-form">
        <div>
            <label>Дата заїзду:</label>
            <input type="date" name="checkIn" th:value="${checkIn}">
        </div>

        <div>
            <label>Дата виїзду:</label>
            <input type="date" name="checkOut" th:value="${checkOut}">
        </div>

        <div>
            <label>Статус:</label>
            <select name="filter">
                <option value="all" th:selected="${currentFilter == 'all'}">Всі</option>
                <option value="available" th:selected="${currentFilter == 'available'}">Вільні</option>
                <option value="occupied" th:selected="${currentFilter == 'occupied'}">Зайняті</option>
            </select>
        </div>

        <button type="submit" class="button">Фільтрувати</button>
    </form>

    <!-- Таблиця кімнат -->
    <table border="1" class="rooms-table">
        <thead>
        <tr>
            <th>Номер кімнати</th>
            <th>Тип</th>
            <th>Ціна</th>
            <th>Доступність</th>
            <th>Дії</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="room : ${rooms}" class="room-row">
            <td th:text="${room.roomNumber}"></td>
            <td th:text="${room.type}"></td>
            <td th:text="${room.price}"></td>
            <td>
                <span th:text="${room.availableForDates ? 'Вільна' : 'Зайнята'}"></span>
            </td>

            <td>
                <button
                        th:if="${room.availableForDates}"
                        class="button book-button"
                        th:attr="data-room-id=${room.id}"
                        data-check-in="${checkIn}"
                        data-check-out="${checkOut}"
                >Забронювати</button>
                <span th:unless="${room.availableForDates}">Недоступно</span>
            </td>

        </tr>
        </tbody>
    </table>

    <!-- Повідомлення після відправлення відгуку -->
    <span th:if="${flash != null and flash.success != null}">Success</span>
    <!-- Форма для відгуку -->
    <div th:if="${#authentication.isAuthenticated()}" class="review-form">
        <h2>Залишити відгук</h2>
        <form th:action="@{/{hotelId}/reviews(hotelId=${hotelId})}" method="post">
            <div>
                <label>Рейтинг (1-5):</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5"><label for="star5" class="star">&#9733;</label>
                    <input type="radio" id="star4" name="rating" value="4"><label for="star4" class="star">&#9733;</label>
                    <input type="radio" id="star3" name="rating" value="3"><label for="star3" class="star">&#9733;</label>
                    <input type="radio" id="star2" name="rating" value="2"><label for="star2" class="star">&#9733;</label>
                    <input type="radio" id="star1" name="rating" value="1"><label for="star1" class="star">&#9733;</label>
                </div>
            </div>

            <div>
                <label>Коментар:</label>
                <textarea name="comment" required class="comment-textarea"></textarea>
            </div>
            <button type="submit" class="button">Надіслати</button>
        </form>
    </div>
    <div th:if="${#authentication.isAuthenticated() == false}" class="review-form-disabled">
        <h2>Залишити відгук</h2>
        <p>Будь ласка, авторизуйтесь для того, щоб залишити відгук.</p>
    </div>

    <!-- Список відгуків -->
    <h2>Відгуки</h2>
    <div th:each="review : ${reviews}" class="review">
        <p><strong>Користувач:</strong> <span th:text="${review.user.getFullName()}"></span></p>
        <p><strong>Рейтинг:</strong> <span th:text="${review.rating}"></span>/5</p>
        <p><strong>Коментар:</strong> <span th:text="${review.comment}"></span></p>
        <p><small th:text="${#temporals.format(review.createdDate, 'dd-MM-yyyy HH:mm')}"></small></p>
        <hr>
    </div>


    <!-- Додайте цей блок для відображення повідомлень -->
    <div id="booking-message" class="hidden"></div>

    <!-- Модальне вікно -->
    <div id="booking-modal" class="modal">
        <div class="booking-container">
            <span class="close-modal">&times;</span>
            <h2>Бронювання кімнати</h2>
            <form id="booking-form" method="post" class="booking-form">
                <input type="hidden" id="room-id" name="roomId">


                <div class="input-group">
                    <label>Дата заїзду:</label>
                    <input type="date" id="check-in" name="checkInDate" required>
                </div>

                <div class="input-group">
                    <label>Дата виїзду:</label>
                    <input type="date" id="check-out" name="checkOutDate" required>
                </div>

                <button type="submit" class="button">Підтвердити бронювання</button>
            </form>
        </div>
    </div>
    <a href="/" class="back-link">Back to Home</a>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('booking-modal');
        const bookingForm = document.getElementById('booking-form');

        // Анімація для інпутів
        document.querySelectorAll('#booking-form input').forEach(input => {
            input.addEventListener("focus", () => {
                input.style.borderColor = "#007bff";
            });
            input.addEventListener("blur", () => {
                input.style.borderColor = "#ccc";
            });
        });

        // Відкриття/закриття модального вікна
        document.querySelectorAll('.book-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const roomId = parseInt(button.getAttribute('data-room-id'), 10); // Перетворення в число
                document.getElementById('room-id').value = roomId;
                modal.style.display = "flex";
            });
        });

        document.querySelector('.close-modal').addEventListener('click', () => {
            modal.style.display = "none";
        });

        // Відправка форми
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const checkIn = document.getElementById('check-in').value;
            const checkOut = document.getElementById('check-out').value;
            const currentDate = new Date().toISOString().split('T')[0]; // Поточна дата у форматі YYYY-MM-DD

            // Валідація дат
            if (checkIn < currentDate) {
                alert("Дата заїзду не може бути в минулому");
                return;
            }
            if (checkOut <= checkIn) {
                alert("Дата виїзду має бути після дати заїзду");
                return;
            }
            const formData = {
                roomId: document.getElementById('room-id').value,
                checkInDate: document.getElementById('check-in').value,
                checkOutDate: document.getElementById('check-out').value
            };

            try {
                const response = await fetch('/bookings/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' // Важливий заголовок
                    },
                    body: JSON.stringify(formData),
                    credentials: 'include' // Для передачі куків автентифікації
                });

                // Обробка HTTP-статусів
                if (response.status === 401) {
                    alert("Будь ласка, увійдіть в систему.");
                    window.location.href = "/login";
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "Помилка сервера");
                }

                const result = await response.json();
                alert(result.message);
                modal.style.display = "none";
                window.location.reload();

            } catch (error) {
                console.error('Помилка:', error);
                alert("Помилка: " + error.message);
            }
        });
    });

</script>
</body>
</html>
