<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Profile</title>
    <link rel="stylesheet" href="/profile.css">

</head>
<body>


<div id="managerRequestModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <form id="managerRequestForm" th:action="@{/profile/request-manager}" method="post">
            <label>Назва готелю:</label>
            <input type="text" name="hotelName" required>

            <label>Адреса готелю:</label>
            <input type="text" name="hotelAddress" required>

            <button type="submit">Надіслати</button>
        </form>
    </div>
</div>

<div class="header">
    <a href="/" class="logo-link">
        <img src="/logo.png" alt="Logo" class="logo">
        <h1 class="site-name">Hotel Booking</h1>
    </a>
    <form th:action="@{/logout}" method="post" class="logout-form">
        <button type="submit" class="logout-btn">Вийти</button>
    </form>
</div>

<div th:if="${message}">
    <p style="color: green;" th:text="${message}"></p>
</div>
<div th:if="${error}">
    <p style="color: red;" th:text="${error}"></p>
</div>

<div class="container">
    <div class="sidebar">
        <!-- Navigation tabs -->
        <button class="tab-link active" onclick="openTab(event, 'personalInfo')">Персональна інформація</button>
        <button class="tab-link" onclick="openTab(event, 'bookings')">Історія бронювань</button>
        <button class="tab-link" th:if="${isManager}" onclick="openTab(event, 'manager')">Управління готелями</button>
    </div>

    <!-- Tab content -->
    <div class="tab-content-wrapper">
        <div id="personalInfo" class="tab-content">
            <h2>Personal Information</h2>
            <p>ID: <span th:text="${user.id}"></span></p>
            <p>Name: <span th:text="${user.firstName + ' ' + user.lastName}"></span></p>
            <p>Email: <span th:text="${user.email}"></span></p>
            <p>Phone: <span th:text="${user.phone}"></span></p>

            <div th:unless="${#lists.contains(user.roles, T(org.booking.hotelbooking.Entity.Role).ROLE_MANAGER)}">
                <button onclick="openManagerRequestModal()">Надіслати запит на роль менеджера</button>
            </div>
        </div>

        <div id="bookings" class="tab-content">
            <h2>Booking History</h2>
            <table>
                <thead>
                <tr>
                    <th>Booking ID</th>
                    <th>Room Number</th>
                    <th>Check-in Date</th>
                    <th>Check-out Date</th>
                    <th>Transfer</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="booking : ${user.bookings}">
                    <td th:text="${booking.id}"></td>
                    <td th:text="${booking.room.roomNumber}"></td>
                    <td th:text="${#temporals.format(booking.checkInDate, 'dd-MM-yyyy')}"></td>
                    <td th:text="${#temporals.format(booking.checkOutDate, 'dd-MM-yyyy')}"></td>

                    <!-- Дії (Скасування / Передача) -->
                    <td>
                        <div th:if="${booking.status.name() != 'COMPLETED'}">
                            <form th:action="@{/bookings/{bookingId}/cancel(bookingId=${booking.id})}" method="post" style="display:inline;">
                                <button type="submit">Скасувати</button>
                            </form>
                            <a th:href="@{/bookings/{bookingId}/transfer(bookingId=${booking.id})}">Передати</a>
                        </div>
                        <span th:if="${booking.status.name() == 'COMPLETED'}" style="color: gray;">—</span>
                    </td>

                    <!-- Статус -->
                    <td>
                        <span th:text="${booking.status?.name()}"></span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="manager" class="tab-content">
            <h2>Управління вашими готелями</h2>
            <a th:href="@{/manager/create-hotel}">
                <button>Створити новий готель</button>
            </a>
            <div th:if="${not #lists.isEmpty(userHotels)}">
                <table>
                    <thead>
                    <tr>
                        <th>Назва готелю</th>
                        <th>Місто</th>
                        <th>Дії</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="hotel : ${userHotels}">
                        <td th:text="${hotel.name}"></td>
                        <td th:text="${hotel.city}"></td>
                        <td>
                            <a th:href="@{/manager/hotels/{hotelId}(hotelId=${hotel.id}, userId=${user.id})}">Редагувати готель</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${#lists.isEmpty(userHotels)}">
                <p>У вас поки немає готелів для управління.</p>
            </div>
        </div>
    </div>
</div>
<script>
    function openTab(evt, tabName) {
        var i, tabContent, tabLinks;

        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }

        tabLinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tabLinks.length; i++) {
            tabLinks[i].classList.remove("active");
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    function openManagerRequestModal() {
        document.getElementById('managerRequestModal').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('managerRequestModal');
        const closeModal = document.querySelector('.close');
        const openModalButton = document.querySelector('button[onclick="openManagerRequestModal()"]');
        const form = document.getElementById('managerRequestForm');

        // Закриття модального вікна
        if (closeModal) {
            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        // Закриття при кліку поза модальним вікном
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Обробник відправки форми
        if (form) {
            form.addEventListener('submit', () => {
                // Збереження часу відправки в localStorage
                localStorage.setItem('lastRequestTime', Date.now());
            });
        }

        // Перевірка часу блокування при завантаженні сторінки
        const lastRequestTime = localStorage.getItem('lastRequestTime');
        if (lastRequestTime && openModalButton) {
            const currentTime = Date.now();
            const timePassed = currentTime - parseInt(lastRequestTime);
            const cooldown = 300000; // 5 хвилин

            if (timePassed < cooldown) {
                openModalButton.disabled = true;
                // Автоматичне розблокування після закінчення часу
                setTimeout(() => {
                    openModalButton.disabled = false;
                    localStorage.removeItem('lastRequestTime');
                }, cooldown - timePassed);
            } else {
                localStorage.removeItem('lastRequestTime');
            }
        }


        // Щоб після завантаження сторінки була активна перша вкладка
        document.getElementById('personalInfo').style.display = 'block';
    });
</script>

</body>
</html>
