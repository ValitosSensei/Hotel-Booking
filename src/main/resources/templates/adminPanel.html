<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/admin-panel.css">
<!--    <link rel="stylesheet" href="/manager-panel.css">-->

</head>
<body>
<h1>üè® Admin Dashboard</h1>

<!-- Sidebar -->
<div class="sidebar">
    <div class="nav-tabs">
        <a href="/" class="home-button">
            <i class="fas fa-arrow-left"></i> –ì–æ–ª–æ–≤–Ω–∞
        </a>
        <div class="tab-link active" data-tab="hotels">
            <i class="fas fa-hotel"></i> –ì–æ—Ç–µ–ª—ñ
        </div>
        <div class="tab-link" data-tab="rooms">
            <i class="fas fa-bed"></i> –ö—ñ–º–Ω–∞—Ç–∏
        </div>
        <div class="tab-link" data-tab="users">
            <i class="fas fa-users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
        </div>
        <div class="tab-link" data-tab="requests">
            <i class="fas fa-envelope"></i> –ó–∞–ø–∏—Ç–∏
        </div>
        <div class="tab-link" data-tab="sync">
            <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="content">
    <div id="hotels" class="tab-content">
        <h2>Manage Hotels</h2>
        <table>
            <thead>
            <tr>
                <th>Hotel Name</th>
                <th>City</th>
                <th>Country</th>
                <th>Average Rating</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="hotel : ${hotels}">
                <td th:text="${hotel.name}"></td>
                <td th:text="${hotel.city}"></td>
                <td th:text="${hotel.country}"></td>
                <td th:text="${hotel.averageRating}"></td>
                <td>
                    <a href="#" th:attr="data-id=${hotel.id},
                    data-name=${hotel.name},
                    data-address=${hotel.address},
                    data-city=${hotel.city},
                    data-country=${hotel.country},
                    data-contact=${hotel.contactInfo}"
                       onclick="openEditHotelModal(this)">Edit</a>|
                    <a th:href="@{/admin/deleteHotel/{hotelId}(hotelId=${hotel.id})}">Delete</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Rooms tab -->
<div id="rooms" class="tab-content" style="display: none;">
    <h2>Manage Rooms</h2>
    <table>
        <thead>
        <tr>
            <th>Room Type</th>
            <th>Hotel</th>
            <th>Price</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="room : ${rooms}">
            <td th:text="${room.type}"></td>
            <td th:text="${room.hotel.name}"></td>
            <td th:text="${room.price}"></td>
            <td>
                <a href="#" th:attr="data-id=${room.id},
                    data-number=${room.roomNumber},
                    data-type=${room.type},
                    data-price=${room.price},
                    data-available=${room.availableForDates}"
                   onclick="openEditRoomModal(this)">Edit</a> |
                <a th:href="@{/admin/deleteRoom/{roomId}(roomId=${room.id})}">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Users tab (–≤–∏–¥–∞–ª–∏—Ç–∏ –¥—É–±–ª—å–æ–≤–∞–Ω–∏–π –±–ª–æ–∫) -->
<div id="users" class="tab-content" style="display: none;">
    <div th:fragment="users">
        <h2>Manage Users</h2>

        <!-- –ü–æ—à—É–∫–æ–≤–∞ —Ñ–æ—Ä–º–∞ -->
        <form id="userSearchForm" class="user-search-form">
            <input type="email" id="searchEmail" name="email" placeholder="Search by email..." required>
            <button type="submit">Search</button>
        </form>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ -->
        <div id="userResults">
            <table class="user-table">
                <thead>
                <tr>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${searchedUsers}">
                    <td th:text="${user.email}"></td>
                    <td>
                            <span th:each="role : ${user.roles}"
                                  th:text="${role} + ' '"></span>
                    </td>
                    <td>
                        <form th:action="@{/admin/grant-admin/{userId}(userId=${user.id})}"
                              method="post">
                            <button type="submit">Grant Admin</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${searchedUsers.isEmpty()}">
                    <td colspan="3">No users found</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Requests tab -->
<div id="requests" class="tab-content" style="display: none;">
    <h2>Manager Role Requests</h2>
    <table>
        <thead>
        <tr>
            <th>User</th>
            <th>Request Date</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ –ø—É—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫ -->
        <tr th:if="${requests.isEmpty()}">
            <td colspan="3">No pending requests</td>
        </tr>
        <tr th:each="request : ${requests}">
            <td th:text="${request.user.email}"></td>
            <td th:text="${#temporals.format(request.requestDate, 'dd-MM-yyyy HH:mm')}"></td>
            <td>
                <!-- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è th:attr –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –¥–∞–Ω–∏—Ö -->
                <button class="btn-view"
                        th:attr="
                    data-hotel-name=${request.hotelName},
                    data-hotel-address=${request.hotelAddress},
                    data-user-email=${request.user.email},
                    data-request-date=${#temporals.format(request.requestDate, 'dd-MM-yyyy HH:mm')}"
                        onclick="showRequestDetails(this)">–î–µ—Ç–∞–ª—ñ
                </button>
                <form th:action="@{/admin/approve-request/{id}(id=${request.id})}" method="post">
                    <button type="submit">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                </form>
                <form th:action="@{/admin/reject-request/{id}(id=${request.id})}" method="post">
                    <button type="submit">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<!-- Synchronization tab -->
<div id="sync" class="tab-content" style="display: none;">
    <h2>Sync Hotels via Amadeus API</h2>
    <form id="syncForm">
        <label for="cityCode">City Code:</label>
        <input type="text" id="cityCode" name="cityCode" required>
        <button type="submit">Sync</button>
    </form>

    <h3>Available City Codes:</h3>
    <ul>
        <li>PAR - Paris</li>
        <li>NYC - New York</li>
        <li>LON - London</li>
        <li>BER - Berlin</li>
        <li>ROM - Rome</li>
        <li>AMS - Amsterdam</li>
        <li>BCN - Barcelona</li>
    </ul>

    <div id="syncResult"></div>
</div>

<!-- –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –∫–æ–¥ –ø—ñ—Å–ª—è —Ä–æ–∑–¥—ñ–ª—É "Synchronization tab" -->
<div class="modal-overlay">
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>–î–µ—Ç–∞–ª—ñ –∑–∞–ø–∏—Ç—É</h3>
            <div id="modalContent">
                <p><strong>–ì–æ—Ç–µ–ª—å:</strong> <span id="modalHotelName"></span></p>
                <p><strong>–ê–¥—Ä–µ—Å–∞:</strong> <span id="modalHotelAddress"></span></p>
                <p><strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> <span id="modalUserEmail"></span></p>
                <p><strong>–î–∞—Ç–∞ –∑–∞–ø–∏—Ç—É:</strong> <span id="modalRequestDate"></span></p>
            </div>
        </div>
    </div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≥–æ—Ç–µ–ª—é -->
<div id="editHotelModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≥–æ—Ç–µ–ª—å</h3>
        <form id="hotelForm" th:action="@{/admin/editHotel/{hotelId}}" method="post">
            <input type="hidden" name="id" id="editHotelId">
            <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞" required>
            <input type="text" name="address" placeholder="–ê–¥—Ä–µ—Å–∞">
            <input type="text" name="city" placeholder="–ú—ñ—Å—Ç–æ">
            <input type="text" name="country" placeholder="–ö—Ä–∞—ó–Ω–∞">
            <input type="text" name="contactInfo" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–∏">
            <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </form>
    </div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏ -->
<div id="editRoomModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</h3>
        <form id="roomForm" th:action="@{/admin/editRoom/{roomId}}" method="post">
            <input type="hidden" name="id" id="editRoomId">
            <input type="text" name="roomNumber" placeholder="–ù–æ–º–µ—Ä">
            <input type="text" name="type" placeholder="–¢–∏–ø">
            <input type="number" name="price" placeholder="–¶—ñ–Ω–∞">
            <label>
                <input type="checkbox" name="availableForDates"> –î–æ—Å—Ç—É–ø–Ω–∞
            </label>
            <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </form>
    </div>
</div>

<script>

    function openEditHotelModal(button) {
        const hotel = {
            id: button.getAttribute('data-id'),
            name: button.getAttribute('data-name'),
            address: button.getAttribute('data-address'),
            city: button.getAttribute('data-city'),
            country: button.getAttribute('data-country'),
            contact: button.getAttribute('data-contact')
        };

        document.getElementById('editHotelId').value = hotel.id;
        document.querySelector('#editHotelModal input[name="name"]').value = hotel.name;
        document.querySelector('#editHotelModal input[name="address"]').value = hotel.address || '';
        document.querySelector('#editHotelModal input[name="city"]').value = hotel.city || '';
        document.querySelector('#editHotelModal input[name="country"]').value = hotel.country || '';
        document.querySelector('#editHotelModal input[name="contactInfo"]').value = hotel.contact || '';

        openModal('editHotelModal');
    }

    function openEditRoomModal(button) {
        const room = {
            id: button.getAttribute('data-id'),
            number: button.getAttribute('data-number'),
            type: button.getAttribute('data-type'),
            price: button.getAttribute('data-price'),
            available: button.getAttribute('data-available') === 'true'
        };

        document.getElementById('editRoomId').value = room.id;
        document.querySelector('#editRoomModal input[name="roomNumber"]').value = room.number || '';
        document.querySelector('#editRoomModal input[name="type"]').value = room.type || '';
        document.querySelector('#editRoomModal input[name="price"]').value = room.price || '';
        document.querySelector('#editRoomModal input[name="availableForDates"]').checked = room.available;

        openModal('editRoomModal');
    }

    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º
    document.getElementById('hotelForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm(this, '/admin/editHotel/' + document.getElementById('editHotelId').value);
    });

    document.getElementById('roomForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm(this, '/admin/editRoom/' + document.getElementById('editRoomId').value);
    });

    function submitForm(form, action) {
        form.action = action;
        form.submit();
        closeModal();
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π
    function showRequestDetails(button) {
        const hotelName = button.getAttribute('data-hotel-name');
        const hotelAddress = button.getAttribute('data-hotel-address');
        const userEmail = button.getAttribute('data-user-email');
        const requestDate = button.getAttribute('data-request-date');

        document.getElementById('modalHotelName').textContent = hotelName;
        document.getElementById('modalHotelAddress').textContent = hotelAddress;
        document.getElementById('modalUserEmail').textContent = userEmail;
        document.getElementById('modalRequestDate').textContent = requestDate;

        openModal('requestDetailsModal');
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        const overlay = document.querySelector('.modal-overlay');

        overlay.style.display = 'block';
        modal.style.display = 'block';

        setTimeout(() => {
            overlay.style.opacity = '1';
            modal.style.opacity = '1';
            modal.style.transform = 'translate(-50%, -50%) scale(1)';
        }, 10);
    }


    // –§—É–Ω–∫—Ü—ñ—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
    function closeModal() {
        const modals = document.querySelectorAll('.modal');
        const overlay = document.querySelector('.modal-overlay');

        modals.forEach(modal => {
            modal.style.opacity = '0';
            modal.style.transform = 'translate(-50%, -50%) scale(0.9)';
        });

        overlay.style.opacity = '0';

        setTimeout(() => {
            modals.forEach(modal => modal.style.display = 'none');
            overlay.style.display = 'none';
        }, 10);
    }

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –≤—ñ–∫–Ω–æ–º
    document.querySelector('.modal-overlay').addEventListener('click', closeModal);
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', e => e.stopPropagation());
    });

    const tabs = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            const currentActive = document.querySelector('.tab-content:not([style*="display: none"])');

            // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤–∏—Ö–æ–¥—É
            if(currentActive) {
                currentActive.style.opacity = '0';
                currentActive.style.transform = 'translateX(30px)';
            }

            setTimeout(() => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => {
                    content.style.display = 'none';
                    content.style.opacity = '0';
                    content.style.transform = 'translateX(30px)';
                });

                this.classList.add('active');
                const targetContent = document.getElementById(targetTab);
                targetContent.style.display = 'block';

                // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤—Ö–æ–¥—É
                setTimeout(() => {
                    targetContent.style.opacity = '1';
                    targetContent.style.transform = 'translateX(0)';
                }, 50);
            }, 50);
        });
    });

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—à–æ—ó –≤–∫–ª–∞–¥–∫–∏
    document.querySelector('.tab-link.active').click();

    // Handle user search form
    // –û–±—Ä–æ–±–Ω–∏–∫ —Ñ–æ—Ä–º–∏ –ø–æ—à—É–∫—É
    document.getElementById('userSearchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('searchEmail').value;

        fetch(`/admin/searchUser?email=${encodeURIComponent(email)}`)
            .then(response => {
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
                return response.text();
            })
            .then(html => {
                document.getElementById('userResults').innerHTML = html;
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                document.getElementById('userResults').innerHTML = `
                <tr><td colspan="3">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</td></tr>`;
            });
    });
</script>

</body>

</html>
